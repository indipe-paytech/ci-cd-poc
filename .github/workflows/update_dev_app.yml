name: Update Staging App

on:
  workflow_dispatch:
  push:
    branches:
      - stg/*

jobs:
  android:
    environment:
      name: android
      url: ${{ steps.deployments.outputs.alias }}

    name: Build Android App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Partner repository
        uses: actions/checkout@v4.1.7
        with:
          repository: indipe-paytech/indipe-partner-app
          submodules: recursive
          token: ${{ secrets.GH_PAT }}

      - name: Get Partner Details
        id: partners
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://mocki.io/v1/2d2c2f38-ad15-4e67-a767-2b4f7d1dee61'
          method: 'GET'

      - name: Download Assets
        run: |
          assets=$(echo '${{ steps.partners.outputs.response }}' | jq -c '.assets[]')
          mkdir -p ./assets
          for asset in $assets; do
            url=$(echo $asset | jq -r '.url')
            name=$(echo $asset | jq -r '.name')
            file="./assets/$(basename "$url")"
            wget -nc -P $file $url

            rename="./assets/$name"
            if [ "$file" != "$rename" ]; then
              mv $file $rename
            fi
          done
        shell: bash

      - name: Move Assets
        run: |
          rm -rf ./packages/app/assets/logos/*
          cp -r ./assets/* ./packages/app/assets/logos/
          rm -rf ./assets
        shell: bash

      - name: Set Secret Environment Variables from API Response
        run: |
          partner=${{ fromJson(steps.partners.outputs.response) }}
          echo "FIREBASE_TOKEN=$partner.firebase_token" >> $GITHUB_OUTPUT
          echo "ANDROID_KEYSTORE=$partner.keystore" >> $GITHUB_OUTPUT
          echo "ANDROID_KEYSTORE_PASSWORD=$partner.keystore_password" >> $GITHUB_OUTPUT
          echo "ANDROID_KEY_ALIAS=$partner.key_alias" >> $GITHUB_OUTPUT
          echo "ANDROID_KEY_PASSWORD=$partner.key_password" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache Current State
        id: current-state
        uses: actions/cache@v4.0.2
        with:
          path: ./*
          key: ${{ runner.os }}-app-${{ github.ref }}

  build-android:
    needs: android
    uses: indipe-paytech/shared-mobile-workflows/.github/workflows/build.yml@assets-gen
    with:
      ENVIRONMENT: STAGING_ENV
      DOPPLER_CONFIG: stg
      APP_VERSION: 0.0.${{ github.run_number }}
      APP_NUMBER: $(( ${{ github.run_number }} + 55 ))
      ASSETS_GEN: true
      SKIP_CHECKOUT: true
    secrets:
      GH_PAT: ${{ secrets.GH_PAT }}
      DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
      FIREBASE_TOKEN: ${{ needs.android.outputs.FIREBASE_TOKEN }}
      ANDROID_KEYSTORE: ${{ needs.android.outputs.ANDROID_KEYSTORE }}
      ANDROID_KEYSTORE_PASSWORD: ${{ needs.android.outputs.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ needs.android.outputs.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ needs.android.outputs.ANDROID_KEY_PASSWORD }}
